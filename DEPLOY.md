# Deployment Guide

Скрипт для развертывания на gate сервере с автоматической очисткой устаревших ресурсов.

## Использование

### Базовое развертывание

```bash
./deploy.sh
```

### С указанием SSH ключа

```bash
SSH_KEY=~/.ssh/id_rsa ./deploy.sh
```

### С указанием пользователя

```bash
REMOTE_USER=deploy ./deploy.sh
```

### С указанием директории на сервере

```bash
REMOTE_DIR=/opt/court-registry-mcp ./deploy.sh
```

## Что делает скрипт

1. **Копирует файлы** на сервер через rsync (исключая .git, __pycache__, .env, venv, storage, logs)

2. **Останавливает существующие контейнеры** с флагом `--remove-orphans`

3. **Очищает устаревшие ресурсы**:
   - Старые Docker образы (оставляет последние 2 версии)
   - Dangling образы
   - Неиспользуемые volumes
   - Остановленные контейнеры
   - Старые .pyc файлы
   - Старые __pycache__ директории
   - Лог файлы старше 7 дней

4. **Собирает образ** приложения с флагом `--no-cache`

5. **Запускает все контейнеры** (включая Kafka, PostgreSQL, Redis, Prometheus, Grafana)

## Требования

- SSH доступ к серверу `gate.lexapp.co.ua`
- Docker и docker-compose на удаленном сервере
- Права на выполнение sudo для docker команд
- rsync на локальной машине

## Переменные окружения

- `SSH_KEY` - путь к SSH ключу (опционально)
- `REMOTE_USER` - пользователь на удаленном сервере (по умолчанию: текущий пользователь)
- `REMOTE_DIR` - директория на сервере (по умолчанию: ~/court-registry-mcp)

## Безопасность

⚠️ **Важно**: Скрипт удаляет неиспользуемые Docker volumes. Убедитесь, что важные данные сохранены в постоянных volumes или бэкапах.

## Troubleshooting

### Ошибка подключения SSH
- Проверьте доступность сервера: `ping gate.lexapp.co.ua`
- Проверьте SSH ключ: `ssh -i $SSH_KEY $REMOTE_USER@gate.lexapp.co.ua`

### Ошибка Docker
- Убедитесь, что docker-compose установлен на сервере
- Проверьте права пользователя на выполнение docker команд

### Ошибка сборки
- Проверьте логи: `docker-compose logs`
- Убедитесь, что .env файл настроен правильно
